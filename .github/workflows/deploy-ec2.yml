name: Deploy to EC2

on:
  push:
    branches: [main]
    paths:
      - "backend/app/**" # backend/app í´ë” ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
      - "backend/requirements.txt" # requirements.txt ë³€ê²½ ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  PROJECT_DIR: /home/ubuntu/rag-app/backend/app # backend/app êµ¬ì¡° ìœ ì§€

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    defaults:
      run:
        working-directory: backend/app # ëª¨ë“  run ëª…ë ¹ì€ backend/app ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 600 ~/.ssh/known_hosts

      - name: Create deployment script
        working-directory: ${{ github.workspace }} # ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ìš©)
        run: |
          cat > deploy.sh << 'DEPLOYSCRIPT'
          #!/bin/bash
          set -e

          echo "ğŸš€ Starting FastAPI deployment..."

          PROJECT_ROOT_DIR=/home/ubuntu/rag-app
          PROJECT_DIR=$PROJECT_ROOT_DIR/backend/app
          SERVICE_NAME=rag-fastapi

          # ë””ë ‰í† ë¦¬ ìƒì„± (í™ˆ ë””ë ‰í† ë¦¬ì´ë¯€ë¡œ sudo ë¶ˆí•„ìš”)
          mkdir -p $PROJECT_DIR
          mkdir -p $PROJECT_DIR/models/midm

          # backend ë””ë ‰í† ë¦¬ êµ¬ì¡° ìƒì„± (import ê²½ë¡œë¥¼ ìœ„í•´)
          mkdir -p $PROJECT_ROOT_DIR/backend

          cd $PROJECT_DIR

          # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          echo "ğŸ’¾ Checking disk space..."
          df -h / | tail -1
          echo "ğŸ“¦ Available space:"
          df -h $PROJECT_DIR | tail -1

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„± (í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ìƒì„±)
          echo "ğŸ“ Creating .env file..."
          cat > $PROJECT_ROOT_DIR/.env << EOF
          POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          EOF

          # .env íŒŒì¼ í™•ì¸ (ë¹„ë°€ë²ˆí˜¸ëŠ” ë§ˆìŠ¤í‚¹)
          echo "ğŸ“ Verifying .env file..."
          if [ -f $PROJECT_ROOT_DIR/.env ]; then
            echo "âœ… .env file created successfully"
            # POSTGRES_CONNECTION_STRINGì´ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸ (ë¹„ë°€ë²ˆí˜¸ ë§ˆìŠ¤í‚¹)
            if grep -q "POSTGRES_CONNECTION_STRING" $PROJECT_ROOT_DIR/.env; then
              echo "âœ… POSTGRES_CONNECTION_STRING is set"
              # ì—°ê²° ë¬¸ìì—´ì—ì„œ ë¹„ë°€ë²ˆí˜¸ ë¶€ë¶„ ë§ˆìŠ¤í‚¹í•˜ì—¬ ì¶œë ¥
              grep "POSTGRES_CONNECTION_STRING" $PROJECT_ROOT_DIR/.env | sed 's/:[^@]*@/:***@/g'
            else
              echo "âš ï¸  POSTGRES_CONNECTION_STRING is not set"
            fi
          else
            echo "âŒ .env file creation failed"
          fi

          # Python ë²„ì „ í™•ì¸
          PYTHON_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
          PYTHON_MAJOR_MINOR=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2 | tr '.' '_')
          echo "ğŸ“¦ Python version: $(python3 --version)"
          echo "ğŸ“¦ Python version (formatted): $PYTHON_MAJOR_MINOR"

          # Python ê°€ìƒí™˜ê²½ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ğŸ“¦ Installing python3-venv package..."
          sudo apt update -qq

          # Python ë²„ì „ì— ë§ëŠ” venv íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„
          if apt-cache show python${PYTHON_MAJOR_MINOR}-venv > /dev/null 2>&1; then
            echo "ğŸ“¦ Installing python${PYTHON_MAJOR_MINOR}-venv..."
            sudo apt install -y python${PYTHON_MAJOR_MINOR}-venv python3-pip build-essential
          else
            echo "ğŸ“¦ Installing python3-venv (generic)..."
            sudo apt install -y python3-venv python3-pip build-essential
          fi

          # ê¸°ì¡´ ê°€ìƒí™˜ê²½ í™•ì¸ ë° ì¬ìƒì„± (ì†ìƒëœ ê²½ìš° ëŒ€ë¹„)
          if [ -d venv ]; then
            if [ ! -f venv/bin/activate ]; then
              echo "âš ï¸  Existing venv directory is corrupted, removing..."
              rm -rf venv
            else
              echo "âœ… Virtual environment already exists and is valid"
            fi
          fi

          # Python ê°€ìƒí™˜ê²½ ìƒì„±
          if [ ! -d venv ]; then
            echo "ğŸ“¦ Creating Python virtual environment..."
            if python3 -m venv venv 2>&1; then
              echo "âœ… Virtual environment created successfully"
            else
              echo "âŒ venv creation failed, trying alternative method..."
              # ëŒ€ì²´ ë°©ë²•: virtualenv ì‚¬ìš©
              if ! command -v virtualenv &> /dev/null; then
                sudo apt install -y python3-virtualenv
              fi
              if virtualenv venv 2>&1; then
                echo "âœ… Virtual environment created with virtualenv"
              else
                echo "âŒ Both venv methods failed!"
                echo "ğŸ“‹ Python info:"
                python3 --version
                which python3
                exit 1
              fi
            fi
          fi

          # ê°€ìƒí™˜ê²½ ìƒì„± í™•ì¸
          if [ ! -f venv/bin/activate ]; then
            echo "âŒ Virtual environment activation script not found!"
            echo "ğŸ“‹ Checking venv directory..."
            ls -la venv/ || echo "venv directory does not exist"
            echo "ğŸ“‹ Current directory: $(pwd)"
            exit 1
          fi
          echo "âœ… Virtual environment is ready"

          # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ Installing dependencies..."
          source venv/bin/activate
          pip install --upgrade pip

          # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          echo "ğŸ’¾ Disk space before installation:"
          df -h $PROJECT_DIR | tail -1

          # CPU ì „ìš© PyTorch ë¨¼ì € ì„¤ì¹˜ (GPU ë²„ì „ë³´ë‹¤ í›¨ì”¬ ì‘ìŒ, ì•½ 200MB vs 900MB)
          echo "ğŸ“¦ Installing CPU-only PyTorch..."
          pip install --no-cache-dir torch torchvision torchaudio --index-url https://download.pytorch.org/whl/cpu

          # ë‚˜ë¨¸ì§€ ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ Installing other dependencies..."
          pip install --no-cache-dir -r requirements.txt

          # ë””ìŠ¤í¬ ê³µê°„ í™•ì¸
          echo "ğŸ’¾ Disk space after installation:"
          df -h $PROJECT_DIR | tail -1

          # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
          echo "ğŸ“ Creating systemd service..."
          sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null <<EOFSERVICE
          [Unit]
          Description=RAG FastAPI Application
          After=network.target

          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=$PROJECT_ROOT_DIR
          Environment="PATH=$PROJECT_DIR/venv/bin"
          Environment="PYTHONPATH=$PROJECT_ROOT_DIR"
          EnvironmentFile=$PROJECT_ROOT_DIR/.env
          ExecStart=$PROJECT_DIR/venv/bin/uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --workers 2
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOFSERVICE

          # systemd ì¬ë¡œë“œ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ Reloading systemd and restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl enable ${SERVICE_NAME}
          sudo systemctl restart ${SERVICE_NAME}

          # í—¬ìŠ¤ ì²´í¬
          echo "ğŸ¥ Waiting for service to be ready..."
          sleep 10

          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Attempt $i/30: Service not ready yet, waiting..."
            sleep 2
          done

          echo "âŒ Health check failed!"
          echo "ğŸ“‹ Service logs:"
          sudo journalctl -u ${SERVICE_NAME} -n 50 --no-pager
          exit 1
          DEPLOYSCRIPT

      - name: Test EC2 Connection
        working-directory: . # ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
        run: |
          echo "ğŸ” Testing EC2 connection..."
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=10"

          # ì—°ê²° í…ŒìŠ¤íŠ¸ (ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„)
          for i in {1..3}; do
            echo "Attempt $i/3: Testing SSH connection..."
            if ssh $SSH_OPTS ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'echo "Connection successful"'; then
              echo "âœ… Connection successful!"
              exit 0
            fi
            if [ $i -lt 3 ]; then
              echo "â³ Waiting 5 seconds before retry..."
              sleep 5
            fi
          done

          echo "âŒ Failed to connect to EC2 after 3 attempts"
          echo "Please check:"
          echo "1. EC2 instance is running"
          echo "2. Security Group allows SSH (port 22) from GitHub Actions IPs"
          echo "3. EC2_HOST secret is correct: ${{ secrets.EC2_HOST }}"
          exit 1

      - name: Deploy to EC2
        run: |
          # SSH ì˜µì…˜ ì„¤ì • (íƒ€ì„ì•„ì›ƒ ë° ì¬ì‹œë„ ì„¤ì •)
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"

          echo "ğŸ“¦ Creating target directories on EC2..."
          # ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„± (rsync ì „ì— í•„ìš”)
          ssh $SSH_OPTS ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} "mkdir -p ${{ env.PROJECT_DIR }}/models/midm"

          echo "ğŸ“¦ Starting code synchronization..."
          echo "Current directory: $(pwd)"
          echo "Syncing backend/app to EC2..."

          # backend/app í´ë”ë§Œ ë™ê¸°í™” (í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ê°€ backend/appì´ë¯€ë¡œ . ì‚¬ìš©)
          # ëª¨ë¸ íŒŒì¼ ì œì™¸ (ìš©ëŸ‰ì´ í¬ë¯€ë¡œ)
          # rsyncëŠ” -e ì˜µì…˜ìœ¼ë¡œ SSH ì˜µì…˜ì„ ì „ë‹¬í•´ì•¼ í•¨
          rsync -avz --delete -e "ssh $SSH_OPTS" \
            --exclude 'models/midm/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '*.log' \
            --exclude '.pytest_cache/' \
            --exclude '.mypy_cache/' \
            . ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.PROJECT_DIR }}/

          # requirements.txtë„ í•¨ê»˜ ì „ì†¡ (backend/requirements.txt)
          echo "ğŸ“¤ Uploading requirements.txt..."
          scp $SSH_OPTS ../requirements.txt ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.PROJECT_DIR }}/requirements.txt

          # .env íŒŒì¼ë„ PROJECT_DIRì— ìƒì„±ë˜ë„ë¡ í™•ì¸

          echo "ğŸ“¤ Uploading deployment script..."
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ ë° ì‹¤í–‰ (ë£¨íŠ¸ì—ì„œ ìƒì„±ëœ deploy.sh)
          # working-directoryê°€ backend/appì´ë¯€ë¡œ ë£¨íŠ¸ë¡œ ì´ë™í•˜ì—¬ ì „ì†¡
          cd ${{ github.workspace }}
          scp $SSH_OPTS deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/

          echo "ğŸš€ Executing deployment script..."
          ssh $SSH_OPTS ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash ~/deploy.sh'

      - name: Deployment Summary
        if: success()
        working-directory: . # ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Backend API: http://${{ secrets.EC2_HOST }}:8000"
          echo "ğŸ“š API Docs: http://${{ secrets.EC2_HOST }}:8000/docs"
          echo "ğŸ“ Deployed directory: backend/app â†’ /home/ubuntu/rag-app"
