name: Deploy to EC2

on:
  push:
    branches: [main]
    paths:
      - "backend/app/**" # backend/app í´ë” ë³€ê²½ ì‹œì—ë§Œ ì‹¤í–‰
      - "backend/requirements.txt" # requirements.txt ë³€ê²½ ì‹œì—ë„ ì‹¤í–‰
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  PROJECT_DIR: /home/ubuntu/rag-app # í™ˆ ë””ë ‰í† ë¦¬ì— ë°°í¬

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    defaults:
      run:
        working-directory: backend/app # ëª¨ë“  run ëª…ë ¹ì€ backend/app ê¸°ì¤€ìœ¼ë¡œ ì‹¤í–‰

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          chmod 600 ~/.ssh/known_hosts

      - name: Create deployment script
        working-directory: ${{ github.workspace }} # ë£¨íŠ¸ì—ì„œ ì‹¤í–‰ (ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ìƒì„±ìš©)
        run: |
          cat > deploy.sh << 'DEPLOYSCRIPT'
          #!/bin/bash
          set -e

          echo "ğŸš€ Starting FastAPI deployment..."

          PROJECT_DIR=/home/ubuntu/rag-app
          SERVICE_NAME=rag-fastapi

          # ë””ë ‰í† ë¦¬ ìƒì„± (í™ˆ ë””ë ‰í† ë¦¬ì´ë¯€ë¡œ sudo ë¶ˆí•„ìš”)
          mkdir -p $PROJECT_DIR
          mkdir -p $PROJECT_DIR/models/midm

          cd $PROJECT_DIR

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > .env << EOF
          POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          EOF

          # Python ë²„ì „ í™•ì¸
          PYTHON_VERSION=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2)
          PYTHON_MAJOR_MINOR=$(python3 --version | cut -d' ' -f2 | cut -d'.' -f1,2 | tr '.' '_')
          echo "ğŸ“¦ Python version: $(python3 --version)"
          echo "ğŸ“¦ Python version (formatted): $PYTHON_MAJOR_MINOR"

          # Python ê°€ìƒí™˜ê²½ íŒ¨í‚¤ì§€ ì„¤ì¹˜
          echo "ğŸ“¦ Installing python3-venv package..."
          sudo apt update

          # Python ë²„ì „ì— ë§ëŠ” venv íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„
          if apt-cache show python${PYTHON_MAJOR_MINOR}-venv > /dev/null 2>&1; then
            echo "ğŸ“¦ Installing python${PYTHON_MAJOR_MINOR}-venv..."
            sudo apt install -y python${PYTHON_MAJOR_MINOR}-venv python3-pip build-essential
          else
            echo "ğŸ“¦ Installing python3-venv (generic)..."
            sudo apt install -y python3-venv python3-pip build-essential
          fi

          # Python ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
          if [ ! -d venv ]; then
            echo "ğŸ“¦ Creating Python virtual environment..."
            python3 -m venv venv
          fi

          # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ Installing dependencies..."
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r requirements.txt

          # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
          echo "ğŸ“ Creating systemd service..."
          sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null <<EOFSERVICE
          [Unit]
          Description=RAG FastAPI Application
          After=network.target

          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=$PROJECT_DIR
          Environment="PATH=$PROJECT_DIR/venv/bin"
          EnvironmentFile=$PROJECT_DIR/.env
          ExecStart=$PROJECT_DIR/venv/bin/uvicorn main:app --host 0.0.0.0 --port 8000 --workers 2
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOFSERVICE

          # systemd ì¬ë¡œë“œ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ Reloading systemd and restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl enable ${SERVICE_NAME}
          sudo systemctl restart ${SERVICE_NAME}

          # í—¬ìŠ¤ ì²´í¬
          echo "ğŸ¥ Waiting for service to be ready..."
          sleep 10

          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Attempt $i/30: Service not ready yet, waiting..."
            sleep 2
          done

          echo "âŒ Health check failed!"
          echo "ğŸ“‹ Service logs:"
          sudo journalctl -u ${SERVICE_NAME} -n 50 --no-pager
          exit 1
          DEPLOYSCRIPT

      - name: Test EC2 Connection
        working-directory: . # ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
        run: |
          echo "ğŸ” Testing EC2 connection..."
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=10"

          # ì—°ê²° í…ŒìŠ¤íŠ¸ (ìµœëŒ€ 3ë²ˆ ì¬ì‹œë„)
          for i in {1..3}; do
            echo "Attempt $i/3: Testing SSH connection..."
            if ssh $SSH_OPTS ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'echo "Connection successful"'; then
              echo "âœ… Connection successful!"
              exit 0
            fi
            if [ $i -lt 3 ]; then
              echo "â³ Waiting 5 seconds before retry..."
              sleep 5
            fi
          done

          echo "âŒ Failed to connect to EC2 after 3 attempts"
          echo "Please check:"
          echo "1. EC2 instance is running"
          echo "2. Security Group allows SSH (port 22) from GitHub Actions IPs"
          echo "3. EC2_HOST secret is correct: ${{ secrets.EC2_HOST }}"
          exit 1

      - name: Deploy to EC2
        run: |
          # SSH ì˜µì…˜ ì„¤ì • (íƒ€ì„ì•„ì›ƒ ë° ì¬ì‹œë„ ì„¤ì •)
          SSH_OPTS="-o StrictHostKeyChecking=no -o UserKnownHostsFile=~/.ssh/known_hosts -o ConnectTimeout=30 -o ServerAliveInterval=60 -o ServerAliveCountMax=3"

          echo "ğŸ“¦ Starting code synchronization..."
          echo "Current directory: $(pwd)"
          echo "Syncing backend/app to EC2..."

          # backend/app í´ë”ë§Œ ë™ê¸°í™” (í˜„ì¬ ì‘ì—… ë””ë ‰í† ë¦¬ê°€ backend/appì´ë¯€ë¡œ . ì‚¬ìš©)
          # ëª¨ë¸ íŒŒì¼ ì œì™¸ (ìš©ëŸ‰ì´ í¬ë¯€ë¡œ)
          # rsyncëŠ” -e ì˜µì…˜ìœ¼ë¡œ SSH ì˜µì…˜ì„ ì „ë‹¬í•´ì•¼ í•¨
          rsync -avz --delete -e "ssh $SSH_OPTS" \
            --exclude 'models/midm/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '*.log' \
            --exclude '.pytest_cache/' \
            --exclude '.mypy_cache/' \
            . ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.PROJECT_DIR }}/

          # requirements.txtë„ í•¨ê»˜ ì „ì†¡ (backend/requirements.txt)
          echo "ğŸ“¤ Uploading requirements.txt..."
          scp $SSH_OPTS ../requirements.txt ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.PROJECT_DIR }}/requirements.txt

          echo "ğŸ“¤ Uploading deployment script..."
          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ ë° ì‹¤í–‰ (ë£¨íŠ¸ì—ì„œ ìƒì„±ëœ deploy.sh)
          # working-directoryê°€ backend/appì´ë¯€ë¡œ ë£¨íŠ¸ë¡œ ì´ë™í•˜ì—¬ ì „ì†¡
          cd ${{ github.workspace }}
          scp $SSH_OPTS deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/

          echo "ğŸš€ Executing deployment script..."
          ssh $SSH_OPTS ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash ~/deploy.sh'

      - name: Deployment Summary
        if: success()
        working-directory: . # ë£¨íŠ¸ì—ì„œ ì‹¤í–‰
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Backend API: http://${{ secrets.EC2_HOST }}:8000"
          echo "ğŸ“š API Docs: http://${{ secrets.EC2_HOST }}:8000/docs"
          echo "ğŸ“ Deployed directory: backend/app â†’ /home/ubuntu/rag-app"
