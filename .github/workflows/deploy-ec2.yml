name: Deploy to EC2

on:
  push:
    branches: [main]
  workflow_dispatch:

env:
  EC2_HOST: ${{ secrets.EC2_HOST }}
  EC2_USER: ${{ secrets.EC2_USER }}
  PROJECT_DIR: /opt/rag-app # í”„ë¡œë•ì…˜ í‘œì¤€ ìœ„ì¹˜ (FHS ì¤€ìˆ˜)

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        uses: webfactory/ssh-agent@v0.9.1
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: Add EC2 to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Create deployment script
        run: |
          cat > deploy.sh << 'DEPLOYSCRIPT'
          #!/bin/bash
          set -e

          echo "ğŸš€ Starting FastAPI deployment..."

          PROJECT_DIR=/opt/rag-app
          SERVICE_NAME=rag-fastapi

          # ë””ë ‰í† ë¦¬ ìƒì„± ë° ê¶Œí•œ ì„¤ì •
          sudo mkdir -p $PROJECT_DIR
          sudo mkdir -p $PROJECT_DIR/backend/app/models/midm
          sudo chown -R $USER:$USER $PROJECT_DIR

          cd $PROJECT_DIR

          # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
          cat > .env << EOF
          POSTGRES_CONNECTION_STRING=${{ secrets.POSTGRES_CONNECTION_STRING }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          EOF

          # Python ê°€ìƒí™˜ê²½ í™•ì¸ ë° ìƒì„±
          if [ ! -d venv ]; then
            echo "ğŸ“¦ Creating Python virtual environment..."
            python3 -m venv venv
          fi

          # ê°€ìƒí™˜ê²½ í™œì„±í™” ë° ì˜ì¡´ì„± ì„¤ì¹˜
          echo "ğŸ“¦ Installing dependencies..."
          source venv/bin/activate
          pip install --upgrade pip
          pip install -r backend/requirements.txt

          # systemd ì„œë¹„ìŠ¤ íŒŒì¼ ìƒì„±/ì—…ë°ì´íŠ¸
          echo "ğŸ“ Creating systemd service..."
          sudo tee /etc/systemd/system/${SERVICE_NAME}.service > /dev/null <<EOFSERVICE
          [Unit]
          Description=RAG FastAPI Application
          After=network.target

          [Service]
          Type=simple
          User=$USER
          WorkingDirectory=$PROJECT_DIR
          Environment="PATH=$PROJECT_DIR/venv/bin"
          EnvironmentFile=$PROJECT_DIR/.env
          ExecStart=$PROJECT_DIR/venv/bin/uvicorn backend.app.main:app --host 0.0.0.0 --port 8000 --workers 2
          Restart=always
          RestartSec=10

          [Install]
          WantedBy=multi-user.target
          EOFSERVICE

          # systemd ì¬ë¡œë“œ ë° ì„œë¹„ìŠ¤ ì¬ì‹œì‘
          echo "ğŸ”„ Reloading systemd and restarting service..."
          sudo systemctl daemon-reload
          sudo systemctl enable ${SERVICE_NAME}
          sudo systemctl restart ${SERVICE_NAME}

          # í—¬ìŠ¤ ì²´í¬
          echo "ğŸ¥ Waiting for service to be ready..."
          sleep 10

          for i in {1..30}; do
            if curl -f http://localhost:8000/api/v1/health > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            echo "Attempt $i/30: Service not ready yet, waiting..."
            sleep 2
          done

          echo "âŒ Health check failed!"
          echo "ğŸ“‹ Service logs:"
          sudo journalctl -u ${SERVICE_NAME} -n 50 --no-pager
          exit 1
          DEPLOYSCRIPT

      - name: Deploy to EC2
        run: |
          # ì½”ë“œ ë™ê¸°í™” (ëª¨ë¸ íŒŒì¼ ë° ë¶ˆí•„ìš”í•œ íŒŒì¼ ì œì™¸)
          rsync -avz --delete \
            --exclude 'backend/app/models/midm/' \
            --exclude 'node_modules/' \
            --exclude '.git/' \
            --exclude '__pycache__/' \
            --exclude '*.pyc' \
            --exclude '.venv/' \
            --exclude 'venv/' \
            --exclude '.env' \
            --exclude '*.log' \
            --exclude '.pytest_cache/' \
            --exclude '.mypy_cache/' \
            ./ ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:${{ env.PROJECT_DIR }}/

          # ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ ì „ì†¡ ë° ì‹¤í–‰
          scp deploy.sh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }}:~/
          ssh ${{ secrets.EC2_USER }}@${{ secrets.EC2_HOST }} 'bash ~/deploy.sh'

      - name: Deployment Summary
        if: success()
        run: |
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Backend API: http://${{ secrets.EC2_HOST }}:8000"
          echo "ğŸ“š API Docs: http://${{ secrets.EC2_HOST }}:8000/docs"
